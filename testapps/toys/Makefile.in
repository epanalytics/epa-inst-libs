CC          = @CC@	
CXX         = @CXX@
FC          = @FC@
MPICC       = @MPICC@

BINDIR      = ../../src
EXECDIR     = bin

OBJS        = foo.o bar.o dum.o main.o
OBJSCPP	    = classes.o
EXTRA_INC   = -I../../instcode
EXTRA_LIBS  = -lm

TARGETS  	= $(EXECDIR)/cTest $(EXECDIR)/cppTest $(EXECDIR)/fTest $(EXECDIR)/dynTest $(EXECDIR)/sgTest
IDETGT		= $(foreach target,$(TARGETS),$(target).ideinst)
JBBTGT		= $(foreach target,$(TARGETS),$(target).jbbinst)
SIMTGT		= $(foreach target,$(TARGETS),$(target).siminst)
THRTGT		= $(foreach target,$(TARGETS),$(target).lpiinst)

PEBIL_COMMAND			=	pebil --silent
PEBIL_COMMAND_I		=	$(PEBIL_COMMAND) --typ
PEBIL_COMMAND_T		=	$(PEBIL_COMMAND) --tool
FILTER_PEBIL_MSGS	=	grep -v "\[Metasim\-r"
LOOPS_FILE				=	all.loops
CREATE_LOOPS_FILE	= echo "*:*:0" > $(LOOPS_FILE)
OUT								=	outp
DIFF							= diff
NULL_FILE = /dev/null

all: createDir $(TARGETS) 
	echo $(TARGETS)

### Make Targets
%.o: %.c
	$(CC) -g -c -o $@ $< 

%.o: %.C
	$(CXX) -g -c -o $@ $< 

$(EXECDIR)/cTest: $(OBJS)
	$(CC) -g -o $@ $(OBJS)

$(EXECDIR)/cppTest: $(OBJSCPP)
	$(CXX) -g -o $@ $(OBJSCPP)

$(EXECDIR)/fTest:
	$(FC) -g -o $@ fTest.f

$(EXECDIR)/dynTest:
	$(CC) -g -o $@ dynTest.c

$(EXECDIR)/sgTest:
	$(CC) -g -o $@ sgTest.c $(EXTRA_INC) $(EXTRA_LIBS)

createDir:
	mkdir -p $(EXECDIR)

### PEBIL Checks

check: createDir $(TARGETS) checkAppBinary

checkAppBinary: createDir $(TARGETS) $(IDETGT) $(JBBTGT) $(SIMTGT) $(LPITGT)

%.ideinst: %
	$(PEBIL_COMMAND_I) ide --app $<
	$(DIFF) $< $@
	./$@ > $@.$(OUT)
	./$< > $<.$(OUT)
	$(DIFF) $<.$(OUT) $@.$(OUT)

%.jbbinst: %
	$(PEBIL_COMMAND_T) BasicBlockCounter --app $<
	./$@ | $(FILTER_PEBIL_MSGS) > $@.$(OUT)
	./$< > $<.$(OUT)
	$(DIFF) $<.$(OUT) $@.$(OUT)

%.siminst: %
	$(PEBIL_COMMAND_T) CacheSimulation --app $< --inp $(NULL_FILE)
	./$@ | $(FILTER_PEBIL_MSGS) > $@.$(OUT)
	./$< > $<.$(OUT)
	$(DIFF) $<.$(OUT) $@.$(OUT)

%.lpiinst: %
	$(CREATE_LOOPS_FILE)
	$(PEBIL_COMMAND_T) LoopIntercept --app $< --inp $(LOOPS_FILE) --lnc liblooptimer.so
	rm -f $(LOOPS_FILE)
	./$@ | $(FILTER_PEBIL_MSGS) > $@.$(OUT)
	./$< > $<.$(OUT)
	$(DIFF) $<.$(OUT) $@.$(OUT)

clean: 
	rm -f *.o $(TARGETS) *.jbbinst $(EXECDIR)/*.lpiinst $(EXECDIR)/*.siminst $(EXECDIR)/*.ideinst $(EXECDIR)/*.static $(EXECDIR)/*.$(OUT)
