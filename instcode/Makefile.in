STATIC_INST_LIB  = @STATIC_INST_LIB@

PEBIL_LIBS = 
ifeq ($(STATIC_INST_LIB),yes)
	PEBIL_LIBS = libcounter.a  libsimulator.a  libtimer.a  libclassifier.a  libpfreq.a  libtautrace.a  liblptimer.a  cxx_libcounter.a
else
	PEBIL_LIBS = libcounter.so libsimulator.so libtimer.so libclassifier.so libpfreq.so libtautrace.so liblptimer.so cxx_libcounter.so
endif

LIB_TARGETS = $(PEBIL_LIBS)
MPICC       = @MPICC@
MPICXX      = @MPICXX@
CFLAGS      = @CFLAGS@ @MPI_FLAGS@ @CPUFREQ_FLAGS@ @THROTTLER_FLAGS@ -DPER_SET_RECENT -DSHIFT_ADDRESS_BUFFER -w
CXXFLAGS    = -std=c++0x @CXXFLAGS@ @MPI_FLAGS@ @CPUFREQ_FLAGS@ @THROTTLER_FLAGS@ -DPER_SET_RECENT -DSHIFT_ADDRESS_BUFFER -w

SHARED_OPT  = -fPIC
EXTRA_FLAGS = $(SHARED_OPT)
SHARED_LIB  = -shared -ldl
AR          = ar rcs

#### -DNO_SAMPLING_MODE    : Add to disable sampling (note that MAX visit count is still on).
#### -DEXTENDED_SAMPLING   : Add to vary the ignore and sampling intervals during sampling
#### -DFINE_GRAIN_SAMPLING : Add to increase the granularity of sampling. Smaller intervals.
#EXTRA_DEF = -DNO_SAMPLING_MODE # default for MultiMAPS tracing
EXTRA_DEF = -DEXTENDED_SAMPLING # default for application tracing
#EXTRA_DEF = -DIGNORE_ACTUAL_SIMULATION -DNO_SAMPLING_MODE # no simulation

EXTRA_LIBS  =
EXTRA_INC   = -I../instcode

LIBDIR      = ../lib
BINDIR      = ../bin

COMMON_OBJS = InstrumentationCommon.o
CXX_COMMON_OBJS = InstrumentationCommon.O

all: $(LIB_TARGETS)

%.o: %.c
	$(MPICC) $(CFLAGS) $(EXTRA_FLAGS) $(EXTRA_DEF) $(EXTRA_INC) -c -o $@ $< $(SHARED_OPT)
%.O: %.cpp
	$(MPICXX) $(CXXFLAGS) $(EXTRA_FLAGS) $(EXTRA_DEF) $(EXTRA_INC) -c -o $@ $< $(SHARED_OPT)

cxx_libcounter.so : CounterFunctions.O $(CXX_COMMON_OBJS)
	$(MPICXX) $(SHARED_LIB) -o $@ CounterFunctions.O $(CXX_COMMON_OBJS) $(EXTRA_LIBS)
libcounter.so : CounterFunctions.o $(COMMON_OBJS)
	$(MPICC) $(SHARED_LIB) -o $@ CounterFunctions.o $(COMMON_OBJS) $(EXTRA_LIBS)
libcounter.a : CounterFunctions.o $(COMMON_OBJS)
	$(AR) $@ CounterFunctions.o $(COMMON_OBJS)

libsimulator.so : Simulation.o CacheSimulationCommon.o $(COMMON_OBJS)
	$(MPICC) $(SHARED_LIB) -o $@ Simulation.o CacheSimulationCommon.o $(COMMON_OBJS) $(EXTRA_LIBS)
libsimulator.a : Simulation.o CacheSimulationCommon.o $(COMMON_OBJS)
	$(AR) $@ Simulation.o CacheSimulationCommon.o $(COMMON_OBJS)

libtimer.so : TimerFunctions.o $(COMMON_OBJS)
	$(MPICC) $(SHARED_LIB) -o $@ TimerFunctions.o $(COMMON_OBJS) $(EXTRA_LIBS)
libtimer.a : TimerFunctions.o $(COMMON_OBJS) 
	$(AR) $@ TimerFunctions.o $(COMMON_OBJS)

libclassifier.so : ClassifierFunctions.o $(COMMON_OBJS)
	$(MPICC) $(SHARED_LIB) -o $@ ClassifierFunctions.o $(COMMON_OBJS) $(EXTRA_LIBS)
libclassifier.a : ClassifierFunctions.o
	$(AR) $@ ClassifierFunctions.o

libpfreq.so : Frequency.o $(COMMON_OBJS)
	$(MPICC) $(SHARED_LIB) -o $@ Frequency.o $(COMMON_OBJS) $(EXTRA_LIBS)
libpfreq.a : Frequency.o
	$(AR) $@ Frequency.o

liblptimer.so : LoopTimer.o $(COMMON_OBJS)
	$(MPICC) $(SHARED_LIB) -o $@ LoopTimer.o $(COMMON_OBJS) $(EXTRA_LIBS)

libtautrace.so : tautrace.o $(COMMON_OBJS)
	$(MPICC) $(SHARED_LIB) -o $@ tautrace.o $(COMMON_OBJS) $(EXTRA_LIBS)
libtautrace.a : tautrace.o
	$(AR) $@ tautrace.o

clean: 
	rm -f *.o *.O *.i *.s *.ii $(LIB_TARGETS)

install:
	cp $(LIB_TARGETS) $(LIBDIR)
